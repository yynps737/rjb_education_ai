# AI Education Assistant Platform - Technical Architecture

**作者**: Kisir  
**邮箱**: kikiboy1120@gmail.com  
**更新日期**: 2025-01-06

## 1. 系统架构总览

### 1.1 架构原则
- **模块化设计**：高内聚、低耦合的组件设计
- **分层架构**：清晰的职责划分和依赖管理
- **异步优先**：提升系统吞吐量和响应性能
- **安全第一**：多层安全防护机制
- **可扩展性**：支持水平和垂直扩展
- **AI驱动**：深度集成大语言模型能力

### 1.2 系统架构图
```
┌────────────────────────────────────────────────────────┐
│                    客户端层                            │
│          Web浏览器 / 移动应用 / API客户端              │
└────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────┐
│                    网关层                              │
│              Nginx (反向代理/负载均衡)                 │
└────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────┐
│                  应用服务层                            │
│                FastAPI Application                     │
│  ┌─────────────┬──────────────┬──────────────────┐    │
│  │   API路由   │   中间件     │    依赖注入      │    │
│  │  (Routers)  │ (Middleware) │ (Dependencies)   │    │
│  └─────────────┴──────────────┴──────────────────┘    │
└────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────┐
│                  业务逻辑层                            │
│  ┌──────────────┬──────────────┬─────────────────┐    │
│  │  课程服务    │   AI服务     │   分析服务      │    │
│  │  作业服务    │  评分服务    │   用户服务      │    │
│  │  知识库服务  │  问答服务    │   认证服务      │    │
│  └──────────────┴──────────────┴─────────────────┘    │
└────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────┐
│                  数据访问层                            │
│               SQLAlchemy ORM                           │
│  ┌──────────────┬──────────────┬─────────────────┐    │
│  │   Models     │ Repositories │   Queries       │    │
│  └──────────────┴──────────────┴─────────────────┘    │
└────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────┐
│                  数据存储层                            │
│  ┌──────────────┬──────────────┬─────────────────┐    │
│  │ PostgreSQL   │    Redis     │   ChromaDB      │    │
│  │  (主数据库)  │   (缓存)     │  (向量数据库)   │    │
│  └──────────────┴──────────────┴─────────────────┘    │
└────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────┐
│                  外部服务层                            │
│  ┌──────────────┬──────────────┬─────────────────┐    │
│  │ DashScope    │   文件存储   │  向量嵌入服务   │    │
│  │ (千问API)    │  (本地/OSS)  │  (DashScope)    │    │
│  └──────────────┴──────────────┴─────────────────┘    │
└────────────────────────────────────────────────────────┘
```

## 2. 核心组件详解

### 2.1 应用服务层 (FastAPI)

#### 2.1.1 技术选型理由
- **高性能**：基于Starlette和Pydantic，性能优异
- **异步支持**：原生async/await支持
- **自动文档**：OpenAPI规范，自动生成API文档
- **类型安全**：强类型检查，减少运行时错误

#### 2.1.2 中间件配置
```python
# CORS中间件
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# 请求日志中间件
@app.middleware("http")
async def log_requests(request: Request, call_next):
    request_id = str(uuid.uuid4())
    request.state.request_id = request_id
    # 日志记录逻辑
```

### 2.2 业务逻辑层

#### 2.2.1 服务模块划分
| 服务模块 | 职责 | 主要功能 |
|---------|------|---------|
| CourseService | 课程管理 | 课程CRUD、章节管理、资源管理 |
| AssignmentService | 作业管理 | 作业发布、提交、批改 |
| AIService | AI集成 | 题目生成、智能批改、问答 |
| AnalyticsService | 数据分析 | 学习进度、成绩分析、报表 |
| KnowledgeService | 知识库 | 文档索引、向量检索、RAG |

#### 2.2.2 设计模式
- **Repository模式**：数据访问抽象
- **Service模式**：业务逻辑封装
- **Factory模式**：对象创建管理
- **Strategy模式**：算法策略选择

### 2.3 数据模型设计

#### 2.3.1 核心实体关系
```mermaid
erDiagram
    User ||--o{ Course : teaches
    User ||--o{ Course : enrolls
    Course ||--o{ Chapter : contains
    Chapter ||--o{ Lesson : contains
    Course ||--o{ Assignment : has
    Assignment ||--o{ Question : contains
    User ||--o{ Submission : submits
    Submission ||--o{ Answer : contains
    Course ||--o{ KnowledgeDocument : references
```

#### 2.3.2 数据库设计原则
- **规范化**：遵循3NF原则
- **索引优化**：关键查询字段建立索引
- **软删除**：is_deleted标记，保留数据
- **审计追踪**：created_at, updated_at时间戳

### 2.4 AI集成架构

#### 2.4.1 千问API集成
```python
class QwenClient:
    def __init__(self):
        self.client = OpenAI(
            api_key=settings.dashscope_api_key,
            base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
        )
        self.model = "qwen-plus"
    
    def generate(self, prompt: str, max_tokens: int = 2000, 
                 temperature: float = 0.7, stream: bool = False):
        """支持流式和非流式生成"""
        response = self.client.chat.completions.create(
            model=self.model,
            messages=[{"role": "user", "content": prompt}],
            max_tokens=max_tokens,
            temperature=temperature,
            stream=stream
        )
        if stream:
            return response  # 返回生成器
        else:
            return response.choices[0].message.content
```

#### 2.4.2 流式输出架构
- **SSE (Server-Sent Events)**：实时推送AI响应
- **前端流式处理**：React状态管理优化
- **错误降级**：流式失败自动降级到普通API
- **性能优化**：使用requestAnimationFrame避免频繁渲染

#### 2.4.3 知识库RAG架构
- **向量嵌入**：使用DashScope text-embedding-v2
- **ChromaDB存储**：高效向量检索
- **上下文构建**：智能选择相关文档
- **参考源追踪**：精确标注知识来源

### 2.5 安全架构

#### 2.5.1 认证与授权
- **JWT认证**：无状态token认证
- **RBAC授权**：基于角色的访问控制
- **权限中间件**：请求级别权限检查

#### 2.5.2 安全防护措施
| 安全威胁 | 防护措施 |
|---------|---------|
| SQL注入 | ORM参数化查询 |
| XSS攻击 | 输入验证和转义 |
| CSRF攻击 | Token验证 |
| 文件上传 | 类型和大小限制 |
| DDoS攻击 | 速率限制 |

## 3. 性能优化策略

### 3.1 缓存策略
- **Redis缓存**：热点数据缓存
- **应用级缓存**：内存缓存
- **CDN缓存**：静态资源缓存

### 3.2 数据库优化
- **连接池**：复用数据库连接
- **查询优化**：避免N+1查询
- **读写分离**：主从架构
- **分表分库**：水平扩展

### 3.3 异步处理
- **异步API**：async/await
- **后台任务**：Celery任务队列
- **批处理**：批量操作优化

## 4. 可扩展性设计

### 4.1 水平扩展
- **无状态设计**：应用服务可水平扩展
- **负载均衡**：Nginx/HAProxy
- **服务发现**：Consul/Etcd

### 4.2 垂直扩展
- **模块化设计**：功能模块独立部署
- **微服务化**：服务拆分
- **消息队列**：解耦服务通信

## 5. 监控与运维

### 5.1 监控体系
- **应用监控**：Prometheus + Grafana
- **日志管理**：ELK Stack
- **链路追踪**：Jaeger
- **告警系统**：AlertManager

### 5.2 运维工具
- **容器化**：Docker
- **编排工具**：Kubernetes
- **CI/CD**：GitHub Actions
- **配置管理**：Ansible

## 6. 近期技术实现亮点

### 6.1 流式AI对话实现
- **服务端SSE推送**：实时传输AI生成内容
- **前端优化渲染**：避免React重渲染性能问题
- **错误处理机制**：优雅降级保证用户体验

### 6.2 批量操作优化
- **知识库批量删除**：支持多选操作
- **权限精确控制**：用户只能删除自己的内容
- **事务处理**：确保数据一致性

### 6.3 向量检索优化
- **ChromaDB集成**：高效向量存储和检索
- **DashScope嵌入**：高质量中文语义理解
- **智能引用**：只显示实际使用的参考源

## 7. 技术改进计划

### 7.1 短期目标（1-3个月）
- 完善单元测试覆盖
- 优化缓存策略
- 增强监控和日志
- 支持更多文档格式

### 7.2 中期目标（3-6个月）
- 微服务化部分模块
- 引入消息队列
- 优化数据库查询
- 增强AI能力

### 7.3 长期愿景（6-12个月）
- 完全云原生架构
- 多模型支持
- 国际化支持
- 移动端适配

---

**文档维护**: 本文档由 Kisir (kikiboy1120@gmail.com) 维护，反映最新的架构决策和技术实现。